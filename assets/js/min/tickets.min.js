function desabilita_priority_select(e){e||($("#priority").prop("disabled",!0),$("#priority").selectpicker("refresh"))}function limpa(){$('input[name="to"]').val(""),$('input[name="email"]').val(""),$('input[name="userid"]').val(""),$('input[name="contactid"]').val(""),$('input[name="telefone"]').val(""),$('input[name="fantasia"]').val(""),$('input[name="telEmpresa"]').val(""),$('input[name="celEmpresa"]').val(""),$('input[name="revenda"]').val(""),$('input[name="ultimo_atendimento"]').val(""),$('input[name="city"]').val(""),$('input[name="address"]').val("")}function insert_ticket_knowledgebase_link(e){var t=$(e).val();""!=t&&$.get(admin_url+"knowledge_base/get_article_by_id_ajax/"+t,function(t){$('textarea[name="message"]');tinymce.activeEditor.execCommand("mceInsertContent",!1,'<a href="'+site_url+"knowledge_base/"+t.slug+'">'+t.subject+"</a>"),$(e).selectpicker("val","")},"json")}function tickets_bulk_action(e){if(0==confirm(appLang.confirm_action_prompt))return!1;var t=$("#mass_delete").prop("checked"),a=[],n={};if(0==t||void 0===t){if(n.status=$("#move_to_status_tickets_bulk").val(),n.department=$("#move_to_department_tickets_bulk").val(),n.priority=$("#move_to_priority_tickets_bulk").val(),n.service=$("#move_to_service_tickets_bulk").val(),n.tags=$("#tags_bulk").tagit("assignedTags"),""==n.status&&""==n.department&&""==n.priority&&""==n.service&&""==n.tags)return}else n.mass_delete=!0;var i=$(".table-tickets").find("tbody tr");$.each(i,function(){var e=$($(this).find("td").eq(0)).find("input");1==e.prop("checked")&&a.push(e.val())}),n.ids=a,$(e).addClass("disabled"),setTimeout(function(){$.post(admin_url+"tickets/bulk_action",n).done(function(){window.location.reload()})},50)}function contact(e,t){void 0===t&&(t=""),$("#clientid").valid()&&$.post(admin_url+"tickets/add_contact/"+e+"/"+t).done(function(e){$("#contact_data").html(e),$("#contact").modal({show:!0,backdrop:"static"}),$("body").off("shown.bs.modal","#contact"),$("body").on("shown.bs.modal","#contact",function(){""==t&&$("#contact").find('input[name="firstname"]').focus()}),init_selectpicker(),init_datepicker(),custom_fields_hyperlink(),validate_contact_form()}).fail(function(e){var t=JSON.parse(e.responseText);alert_float("danger",t.message)})}function validate_contact_form(){_validate_form("#contact-form",{firstname:"required",password:{required:{depends:function(e){var t=$('input[name="send_set_password_email"]');if(""==$('#contact input[name="contactid"]').val()&&0==t.prop("checked"))return!0}}}},contactFormHandler)}function contactFormHandler(e){$('#contact input[name="is_primary"]').prop("disabled",!1);var t=$(e).attr("action"),a=new FormData($(e)[0]);return $.ajax({type:"POST",data:a,mimeType:"multipart/form-data",contentType:!1,cache:!1,processData:!1,url:t}).done(function(e){(e=JSON.parse(e)).success&&alert_float("success",e.message),$.fn.DataTable.isDataTable(".table-contacts")&&$(".table-contacts").DataTable().ajax.reload(null,!1),e.proposal_warning&&0!=e.proposal_warning?($("body").find("#contact_proposal_warning").removeClass("hide"),$("body").find("#contact_update_proposals_emails").attr("data-original-email",e.original_email),$("#contact").animate({scrollTop:0},800)):$("#contact").modal("hide"),1==e.has_primary_contact&&$("#client-show-primary-contact-wrapper").removeClass("hide")}).fail(function(e){alert_float("danger",JSON.parse(e.responseText))}),!1}function ticketCheckDialog(e){$.alert({columnClass:"col-md-10 col-md-offset-1",title:"Atenção!",backgroundDismiss:!0,type:"red",typeAnimated:!0,content:function(){var t=this;return t.setContent("<h5>Os seguintes tickets já foram abertos para este cliente, requisitando este mesmo serviço:</h5>"),$.ajax({url:admin_url+"tickets/get_checked_services_data/?service1="+e.service1+"&service2="+e.service2+"&userid="+e.userid+"&ticketid="+e.ticketid,dataType:"html",method:"get"}).done(function(e){t.setContentAppend(e)}).fail(function(){}).always(function(){})},onContentReady:function(){initDataTableOffline("#tb1")}})}function openresp(e){var t=$("#tr_"+e),a=$("#tb1").DataTable().row(t);if(a.child.isShown())a.child.hide(),t.removeClass("shown");else{var n={};n.ticketid=e,$.get(admin_url+"tickets/sub_table/",n).done(function(e){a.child(e).show(),initDataTableOffline("#tb2","not-order"),t.addClass("shown")})}}$(function(){function e(){$('body.ticket select[name="contactid"]').on("change",function(){var e=$(this).val(),a=$('select[name="project_id"]'),n=a.html("").clone(),i=$(".projects-wrapper");a.selectpicker("destroy").remove(),a=n,$("#project_ajax_search_wrapper").append(n),init_ajax_search("project",a,{customer_id:function(){return $('input[name="userid"]').val()}}),""!=e?(limpa(),$.post(admin_url+"tickets/ticket_change_data/",{contact_id:e}).done(function(e){e=JSON.parse(e),$('input[name="contact_now"]').val(e.contact_data.firstname+" "+e.contact_data.lastname),$('input[name="email_contact_now"]').val(e.contact_data.email),$('input[name="userid"]').val(e.contact_data.userid),$('input[name="to"]').val(e.primary_contact.firstname+" "+e.primary_contact.lastname),$('input[name="emailPrimary"]').val(e.primary_contact.email),$('input[name="phonePrimary"]').val(e.primary_contact.phonenumber),""==e.client_data.telefone?$('input[name="phone_contact_now"]').val(e.contact_data.phonenumber):$('input[name="phone_contact_now"]').val(e.client_data.telefone),$(".observation-content").html(e.client_data.observation),PAINEL==QUANTUM&&(1==e.client_data.flag_backup?$("#backup").html('<span class="label inline-block pull-right" style="border:1px solid #84c529; color:#84c529">Backup configurado</span>'):$("#backup").html('<span class="label inline-block pull-right" style="border:1px solid #f11327; color:#f11327">Backup não configurado</span>')),$('input[name="fantasia"]').val(e.client_data.company),$('input[name="telefoneEmpresa"]').val(e.client_data.phonenumber),$('input[name="city"]').val(e.client_data.city),$('input[name="revenda"]').val(e.client_partner),$('input[name="address"]').val(e.client_data.address),$('input[name="celEmpresa"]').val(e.client_data.cellphone),$("#priority").val(e.client_data.priority_client).change(),PAINEL==INORTE&&($("#name_soli").html(e.solicitantes),$("#name_soli").selectpicker("refresh")),t!=parseInt(e.client_data.userid)&&null!=e.client_data.observation&&($("#observation").modal().find(".modal-body").html(e.client_data.observation),t=parseInt(e.client_data.userid)),null!=e.custom_revenda&&(PAINEL==INORTE?$('input[name="revenda"]').val(e.custom_revenda):$('input[name="revenda"]').val(e.custom_revenda.value)),null!=e.ultimo_atendimento?($('input[name="ultimo_atendimento"]').val(e.ultimo_atendimento),null!=e.validation&&parseInt(e.ultimo_atendimento)>=e.validation&&($("#danger").modal(),$("#priority").val("3").change())):$('input[name="ultimo_atendimento"]').val("Sem atendimentos anteriores"),PAINEL==INORTE&&$('label[for="telefone"]').text("Telefone "+e.contact_data.lastname),e.customer_has_projects?i.removeClass("hide"):i.addClass("hide")})):(limpa(),i.addClass("hide"))})}$("#insert_predefined_reply").on("change",function(e){e.preventDefault();var t=$(this),a=t.val();""!=a&&$.get(admin_url+"tickets/get_predefined_reply_ajax/"+a,function(e){tinymce.activeEditor.execCommand("mceInsertContent",!1,e.message),t.selectpicker("val","")},"json")}),$(".block-sender").on("click",function(){var e=$(this).data("sender");if(""==e)return alert("No Sender Found"),!1;$.post(admin_url+"tickets/block_sender",{sender:e}).done(function(){window.location.reload()})}),$(".add_note_ticket").on("click",function(e){e.preventDefault();var t=$('textarea[name="note_description"]').val(),a=$('input[name="ticketid"]').val();""!=t&&$.post(admin_url+"misc/add_note/"+a+"/ticket",{description:t}).done(function(){window.location.reload()})}),$(".save_changes_settings_single_ticket").on("click",function(e){if(e.preventDefault(),$("#scheduled_date_div").is(":visible")&&(""==$("#scheduled_date").val()||null==$("#scheduled_date").val()))return $("#scheduled_date_div").find("span.help-block").length<=0&&$("#scheduled_date_div").append("<span class='help-block' style='color: red;'>É obrigatório informar uma data!</span>"),!1;var t={};t=$("#settings *").serialize(),t+="&ticketid="+$('input[name="ticketid"]').val(),$.post(admin_url+"tickets/update_single_ticket_settings",t).done(function(e){1==(e=JSON.parse(e)).success&&(void 0!==e.department_reassigned?window.location.href=admin_url+"tickets/":window.location.reload())})}),$('select[name="status_top"]').on("change",function(){var e=$(this).val(),t=$('input[name="ticketid"]').val();$.get(admin_url+"tickets/change_status_ajax/"+t+"/"+e,function(e){alert_float(e.alert,e.message)},"json")}),$('select[name="status"]').on("change",function(){var e=$(this).val(),t=$('input[name="ticketid"]').val();$.post(admin_url+"tickets/change_status_ajax/"+t+"/"+e,{tipo:"verifica"},function(e){alert_float(e.alert,e.message)},"json")}),e(),$('button[name="add_contato"]').click(function(){$("#add_contato_modal").modal()}),$('body.ticket select[name="clientid"]').on("change",function(){setTimeout(function(){var t=$('body.ticket select[name="contactid"]'),a=t.empty("").clone();t.selectpicker("destroy").remove(),t=a,$("#select_contact").append(a),init_ajax_search("contact",t,{tickets_contacts:!0}),e()},1e3)});var t=0;$("body").on("click",".remove_attachment",function(){$(this).parents(".attachment").remove()})}),$("#servicenv2, #service, #clientid").on("change",function(){var e={};e.service1=$("#service").val(),e.service2=$("#servicenv2").val(),e.userid=$("#clientid").val(),e.ticketid=$("input[name=ticketid]").val(),void 0===e.ticketid&&(e.ticketid=""),""!==e.service1&&""!==e.service2&&""!==e.userid&&void 0!==e.service1&&void 0!==e.service2&&void 0!==e.userid&&null!==e.service1&&null!==e.service2&&null!==e.userid&&"153"!==e.service1&&"113"!==e.service2&&($.get(admin_url+"tickets/check_services/",e).done(function(t){"true"===(t=JSON.parse(t)).message&&ticketCheckDialog(e)}),setLocalStorage("messageAfterLoad","true",5))});